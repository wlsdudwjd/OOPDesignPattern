<script setup lang="ts">
  import { ref, computed } from "vue";
  import {
    createCart,
    createCaretaker,
    type CartItem,
    type CartState,
    formatTime,
  } from "./memento/memento";

  // ìƒ˜í”Œ ìƒí’ˆ
  const catalog: CartItem[] = [
    { id: "A", name: "ì—ìŠ¤í”„ë ˆì†Œ", price: 3000, qty: 1 },
    { id: "B", name: "ì•„ë©”ë¦¬ì¹´ë…¸", price: 4000, qty: 1 },
    { id: "C", name: "ì¹´í˜ë¼ë–¼", price: 4500, qty: 1 },
    { id: "D", name: "ì¹˜ì¦ˆì¼€ì´í¬", price: 6500, qty: 1 },
  ];

  const cart = createCart();
  const caretaker = createCaretaker(200);

  const items = ref<CartItem[]>(cart.getState().items);

  function syncUI() {
    items.value = cart.getState().items;
  }
  function save(tag?: string) {
    caretaker.save(cart, tag);
  }

  save("ì´ˆê¸°");

  function add(it: CartItem) {
    cart.addItem({ ...it, qty: 1 });
    save(`Add ${it.name}`);
    syncUI();
  }
  function inc(id: string) {
    const s = cart.getState();
    const target = s.items.find((x) => x.id === id);
    if (!target) return;
    cart.setQty(id, target.qty + 1);
    save(`+ ${target.name}`);
    syncUI();
  }
  function dec(id: string) {
    const s = cart.getState();
    const target = s.items.find((x) => x.id === id);
    if (!target) return;
    cart.setQty(id, Math.max(0, target.qty - 1));
    save(`- ${target.name}`);
    syncUI();
  }
  function remove(id: string) {
    const s = cart.getState();
    const target = s.items.find((x) => x.id === id);
    cart.remove(id);
    save(`Remove ${target?.name ?? id}`);
    syncUI();
  }
  function clearAll() {
    cart.clear();
    save("Clear cart");
    syncUI();
  }

  function undo() { caretaker.undo(cart); syncUI(); }
  function redo() { caretaker.redo(cart); syncUI(); }

  const subtotal = computed(() =>
      items.value.reduce((sum, it) => sum + it.price * it.qty, 0)
  );
</script>

<template>
  <main style="padding:24px; max-width:1000px; margin:auto; font-family:system-ui, sans-serif;">
    <h1>ë©”ë©˜í†  íŒ¨í„´ â€” ì¥ë°”êµ¬ë‹ˆ</h1>

    <section style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; align-items:start;">

      <div style="border:1px solid #ddd; border-radius:10px; padding:12px;">
        <h3 style="margin:4px 0 10px 0;">ìƒí’ˆ</h3>
        <div style="display:grid; grid-template-columns: 1fr auto; gap:8px;">
          <div v-for="p in catalog" :key="p.id" style="display:flex; gap:8px; align-items:center; border:1px solid #eee; border-radius:8px; padding:8px;">
            <div style="flex:1;">
              <div><b>{{ p.name }}</b></div>
              <small>{{ p.price.toLocaleString() }}ì›</small>
            </div>
            <button @click="add(p)">ë‹´ê¸°</button>
          </div>
        </div>
      </div>

      <div style="border:1px solid #ddd; border-radius:10px; overflow:hidden;">
        <header style="display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background:#333;">
          <b>ì¥ë°”êµ¬ë‹ˆ</b>
          <div style="display:flex; gap:8px;">
            <button @click="undo" :disabled="!caretaker.canUndo()">â†©ï¸ Undo</button>
            <button @click="redo" :disabled="!caretaker.canRedo()">â†ªï¸ Redo</button>
            <button @click="clearAll">ğŸ§¹ ë¹„ìš°ê¸°</button>
          </div>
        </header>

        <div style="padding:12px;">
          <div v-if="!items.length" style="opacity:.7;">ë‹´ê¸´ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>

          <div v-for="it in items" :key="it.id"
               style="display:grid; grid-template-columns: 1fr auto auto auto; gap:8px; align-items:center; border-bottom:1px solid #f0f0f0; padding:8px 0;">
            <div>
              <div><b>{{ it.name }}</b></div>
              <small>{{ it.price.toLocaleString() }}ì›</small>
            </div>
            <div style="display:flex; gap:6px; align-items:center;">
              <button @click="dec(it.id)">-</button>
              <span style="min-width:24px; text-align:center;">{{ it.qty }}</span>
              <button @click="inc(it.id)">+</button>
            </div>
            <div style="text-align:right; min-width:90px;">
              <b>{{ (it.price * it.qty).toLocaleString() }}ì›</b>
            </div>
            <div>
              <button @click="remove(it.id)">ì‚­ì œ</button>
            </div>
          </div>

          <div style="text-align:right; margin-top:10px;">
            <b>í•©ê³„:</b> {{ subtotal.toLocaleString() }}ì›
          </div>
        </div>

        <hr style="border:none; border-top:1px solid #eee; margin:0;" />

        <div style="padding:12px;">
          <h4 style="margin:0 0 8px 0;">ìŠ¤ëƒ…ìƒ· íˆìŠ¤í† ë¦¬ (undo stack)</h4>
          <ol style="margin:0; padding-left:18px; max-height:180px; overflow:auto;">
            <li v-for="m in caretaker.history().undo" :key="m.ts">
              {{ formatTime(m.ts) }} <span v-if="m.tag"> â€” {{ m.tag }}</span>
            </li>
          </ol>
          <div v-if="caretaker.history().redo.length" style="opacity:.7; margin-top:6px;">
            <small>redo ëŒ€ê¸° {{ caretaker.history().redo.length }}ê°œ</small>
          </div>
        </div>
      </div>
    </section>
  </main>
</template>

<style scoped>
  button {
    padding: 6px 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background: #444; color: #fff; transition: .15s;
  }
  button:hover { background: #666; }
  button:disabled { opacity: .45; cursor: not-allowed; }
</style>